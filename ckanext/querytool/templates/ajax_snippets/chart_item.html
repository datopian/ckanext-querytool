{% import 'macros/form.html' as form %}

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

<!-- Plotly Locales -->
{% set current_lang = request.environ.CKAN_LANG.lower().replace('_', '-') %}
<script src="https://cdn.plot.ly/plotly-locale-{{ current_lang }}-latest.js"></script>
<!-- --- -->

{% set active_charts = chart %}
{% set main_filters = main_filters.split(',') %}
{% set y_axis_values = y_axis_values.split(',') %}
{% set columns = h.querytool_get_resource_columns(chart_resource, y_axis_values) %}
{% if chart and chart.filter_name %}
    {% set class = '' %}
{% else %}
{% set class = 'hidden' %}
{% endif %}

{% for item in y_axis_values %}
    {% do main_filters.append(item) %}
{% endfor %}
{% set chart_filters = h.querytool_get_resource_columns(chart_resource, main_filters) %}
{% set numeric_columns = h.querytool_get_numeric_resource_columns(chart_resource) %}

<div id="chart_field_{{ n }}" class="item chart_field visualization-fields-section">
  {% set chart_types = h.querytool_get_chart_types() %}
  <div class="item-wrapper">
    {% set chart_id = h.querytool_get_uuid() %}
    <div class="accordion" id="accordion_{{ chart_id }}">

      {# General #}
      <div class="accordion-item">
        <div class="accordion-header accordion-opened">
          <button aria-controls="accordion_{{ chart_id }}_general" data-bs-target="#accordion_{{ chart_id }}_general" type="button" class="accordion-button" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('General') }}
          </button>
        </div>
        <div id="accordion_{{ chart_id }}_general" class="accordion-collapse collapse show">
          <div class="accordion-body">
            {# Type #}
            {% if chart %}
              {% set selected_chart_type = chart.graph %}
            {% else %}
              {% set selected_chart_type = chart_types[0].value %}
            {% endif %}
            {{ form.select('chart_field_graph_' ~ n, label=_('Type'), options=chart_types, selected=selected_chart_type)
            }}

            {# Dimension #}
            <div class="control-group control-select">
              <label class="control-label" for="chart_field_axis_x_{{ n }}">{{ _('Dimension') }}</label>
              <div class="controls ">
                <select id="chart_field_axis_x_{{ n }}" name="chart_field_axis_x_{{ n }}">
                  {% for column in columns %}
                  <option value="{{column}}"{% if chart %}{{ 'selected' if column == chart.x_axis }}{% endif %}>{{column}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            {# Category #}
            {% if selected_chart_type in ['donut', 'pie'] %}
              {% set category_option = 'True' %}
            {% else %}
              {% set category_option = 'False' %}
            {% endif %}
            <div class="control-group control-select">
              <label class="control-label" for="chart_field_category_name_{{ n }}">{{ _('Category') }}</label>
              <div class="controls ">
                <select id="chart_field_category_name_{{ n }}" name="chart_field_category_name_{{ n }}" {{'disabled' if category_option == 'True' else ''}}>
                  <option value="">&mdash; {{ _('Select column') }} &mdash;</option>
                  {% for category in columns %}
                  <option value="{{ category }}"{% if chart %}{{ 'selected' if category == chart.category_name }}{{ 'disabled' if category == chart.x_axis }}{% endif %}>{{ category }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            {# Title #}
            {% if chart %}
              {% set chart_title = chart.title %}
            {% endif %}
            <div class="control-group title">
              <label class="control-label" for="chart_field_title_{{ n }}">{{ _('Title') }}</label>
              <div class="controls ">
                <textarea id="chart_field_title_{{ n }}" name="chart_field_title_{{ n }}" placeholder="{{ _('Chart title') }}" rows="3">{{ chart_title }}</textarea>
              </div>
            </div>

            <div class="control-group title-vars">
              <div class="controls ">
                {% set filters = h.querytool_parse_json(info_query_filters or '[]') %}
                {% set filters = filters|sort(attribute='order') %}
                <select>
                  <option value="" disabled selected>{{_('Add variable to title')}}</option>
                  <optgroup label="{{_('Capitalized')}}">
                    <option value="{measure|capitalize}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|capitalize}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|capitalize}">{{_('Optional Filter')}}</option>
                  </optgroup>
                  <optgroup label="{{_('lowercase')}}" class='text-lowercase'>
                    <option value="{measure|lower}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|lower}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|lower}">{{_('Optional Filter')}}</option>
                  </optgroup>
                </select>

              </div>
            </div>
            <div class="control-group title-help">
              <div class="controls ">
                {% set template_tooltip = "<pre><p>" + _('Variables') + "<br>---<br>{measure}<br>{optional_filter}<br>*" + _('use drop-down list to select variables based on application filters') + "</p><p>" + _('Processed variables') + "<br>---<br>{measure|capitalize}<br>{measure|lower}<br>{measure|upper}<br>" + _('etc') + "</p></pre><p><b><a href='https://mozilla.github.io/nunjucks/templating.html#variables' target='_blank'>" + _('Full templates syntax') + "</a></b></p><p class='muted'><b>" + _('Please note:') + " " + "</b>" + _('Single braces \'{}\' are used for variables') + "</p>" %}
                <span class="editor-info-block">{{_('You can use')}} <a href="#templates" title="" data-trigger="focus" data-target="popover" data-content="{{ template_tooltip }}" data-html="true" data-original-title="{{_('Templates quick reference')}}" data-container="body">{{_('Templates')}}</a> {{_('here')}}</span>
              </div>
            </div>

            {# Additional description #}
            {% if chart %}
              {% set additional_description = chart.additional_description %}
            {% endif %}
            <div class="control-group desc" style="margin-bottom:0;">
              <label class="control-label" for="chart_field_desc_{{ n }}">{{ _('Additional Description') }}</label>
              <div class="controls ">
                <textarea id="chart_field_desc_{{ n }}" name="chart_field_desc_{{ n }}" placeholder="{{ _('Additional description') }}" rows="3">{{ additional_description }}</textarea>
              </div>
            </div>
            <div class="control-group desc-vars" style="margin-bottom:0;">
              <div class="controls ">
                {% set filters = h.querytool_parse_json(info_query_filters or '[]') %}
                {% set filters = filters|sort(attribute='order') %}
                <select>
                  <option value="" disabled selected>{{_('Add variable to description')}}</option>
                  <optgroup label="{{_('Capitalized')}}">
                    <option value="{measure|capitalize}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|capitalize}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|capitalize}">{{_('Optional Filter')}}</option>
                  </optgroup>
                  <optgroup label="{{_('lowercase')}}" class='text-lowercase'>
                    <option value="{measure|lower}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|lower}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|lower}">{{_('Optional Filter')}}</option>
                  </optgroup>
                </select>
              </div>
            </div>
            <div class="control-group title-help">
              <div class="controls ">
                {% set template_tooltip = "<pre><p>" + _('Variables') + "<br>---<br>{measure}<br>{optional_filter}<br>*" + _('use drop-down list to select variables based on application filters') + "</p><p>" + _('Processed variables') + "<br>---<br>{measure|capitalize}<br>{measure|lower}<br>{measure|upper}<br>" + _('etc') + "</p></pre><p><b><a href='https://mozilla.github.io/nunjucks/templating.html#variables' target='_blank'>" + _('Full templates syntax') + "</a></b></p><p class='muted'><b>" + _('Please note:') + " " + "</b>" + _('Single braces \'{}\' are used for variables') + "</p>" %}
                <span class="editor-info-block">{{_('You can use')}} <a href="#templates" title="" data-trigger="focus" data-target="popover" data-content="{{ template_tooltip }}" data-html="true" data-original-title="{{_('Templates quick reference')}}" data-container="body">{{_('Templates')}}</a> {{_('here')}}</span>
              </div>
            </div>

          </div>
        </div>
      </div>

      {# Line Chart additional setup  #}
      {% if selected_chart_type in ['line', 'spline'] %}
        {% set hide_line_options = '' %}
      {% else %}
        {% set hide_line_options = 'hidden' %}
      {% endif %}
      <div class="accordion-item {{ hide_line_options }} line-accordion">
        <div class="accordion-header">
          <button type="button" data-bs-target="#accordion_{{ chart_id }}_line_plotly" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('Line Options') }}
          </button>
        </div>
        {% if chart %}
          {% if chart.plotly %}
          {% set plotly = h.querytool_get_chart_colors(chart.plotly) %}
          {% endif %}
        {% endif %}



        <div id="accordion_{{ chart_id }}_line_plotly" class="accordion-collapse collapse">
          <div class="accordion-body line-width-type">

            <div class="header-labels">
              <label id="lbl-1">{{ _('Type') }}</label>
              <label id="lbl-2">{{ _('Width') }}</label>
            </div>

            {% set line_types = '' %}
            {% set line_types_selection = [] %}
            {% set line_widths = '' %}
            {% set line_widths_selection = [] %}

            {% if chart %}
              {% if chart.line_types %}
                {% set line_types = chart.line_types %}
                {% set line_types_selection = chart.line_types.split(',') %}
              {% endif %}
              {% if chart.line_widths %}
                {% set line_widths = chart.line_widths %}
                {% set line_widths_selection = chart.line_widths.split(',') %}
              {% endif %}
            {% else %}
              <p id="line_type_empty_text">Select and update data to list lines.</p>
            {% endif %}

            {% set line_count = 1 %}
            <input type="hidden" id="chart_field_plotly_line_{{ n }}" name="chart_field_plotly_line_{{ n }}" {% if chart %} value="{{ chart.plotly }}" {% endif %} />
            {% for line in plotly %}
              {% if line['x'] %}
                {% set line_type_title = line['x'][line_count - 1] %}
              {% else %}
                {% set line_type_title = 'Line Type' %}
              {% endif %}

              <div class="control-group control-select ">
                <label class="control-label line_type_label" for="chart_field_line_type_{{ n }}_{{ line_count }}">{{ line_type_title }} </label>
                <select  class="custom_chart_select" id='chart_field_line_type_{{ n }}_{{ line_count }}' name='chart_field_line_type_{{ n }}_{{ line_count }}' style='width:120px'>
                  <option value="solid" {% if line_types %}{{ 'selected' if plotly|length >= line_count and line_types_selection[line_count - 1] == 'solid' }}{% endif %}>{{ _('Solid') }}</option>
                  <option value="dash" {% if line_types %}{{ 'selected' if plotly|length >= line_count and line_types_selection[line_count - 1] == 'dash' }}{% endif %}>{{ _('Dashed') }}</option>
                  <option value="dashdot" {% if line_types %}{{ 'selected' if plotly|length >= line_count and line_types_selection[line_count - 1] == 'dashdot' }}{% endif %}>{{ _('Dash Dot') }}</option>
                  <option value="dot" {% if line_types %}{{ 'selected' if plotly|length >= line_count and line_types_selection[line_count - 1] == 'dot' }}{% endif %}>{{ _('Dotted') }}</option>
                </select>

                <select class="custom_chart_select" id='chart_field_line_width_{{ n }}_{{ line_count }}' name='chart_field_line_width_{{ n }}_{{ line_count }}' style='width:120px'>
                  <option value="2" {% if line_widths %}{{ 'selected' if plotly|length >= line_count and line_widths_selection[line_count - 1] == '2' }}{% endif %}>{{ _('Slim') }}</option>
                  <option value="4" {% if line_widths %}{{ 'selected' if plotly|length >= line_count and line_widths_selection[line_count - 1] == '4' or line_widths_selection[line_count - 1] not in ['2', '6'] }}{% endif %}>{{ _('Regular') }}</option>
                  <option value="6" {% if line_widths %}{{ 'selected' if plotly|length >= line_count and line_widths_selection[line_count - 1] == '6' }}{% endif %}>{{ _('Wide') }}</option>
                </select>
              </div>

              {% set line_count = line_count + 1 %}
            {% endfor %}
            
          </div>
        </div>

      </div>

      {# Chart additional color setup  #}
      <div class="accordion-item {{ hide_color_picker }} color-accordion">
        <div class="accordion-header">
          <button type="button" data-bs-target="#accordion_{{ chart_id }}_chart_plotly" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('Color Section') }}
          </button>
        </div>
        {% if chart %}
          {% if chart.plotly %}
          {% set plotly = h.querytool_get_chart_colors(chart.plotly) %}
          {% endif %}
        {% endif %}


        <div id="accordion_{{ chart_id }}_chart_plotly" class="accordion-collapse collapse">
          <div class="accordion-body">
            
          <div class="control-group control-select chart_field_color_wrap_{{ n }} {% if chart %}{{ 'hidden' if selected_chart_type in ['line','area','spline','scatter'] }}{% endif %}">
            <label class="control-label">{{ _('Color Type') }}</label> &nbsp;
            <select id="chart_field_color_type_{{ n }}" name="chart_field_color_type_{{ n }}">
              <option value=1 {% if chart %}{{ 'selected' if chart.color_type in [1, '1'] }}{% endif %}>{{ _('Divergent') }}</option>
              <option value=2 {% if chart %}{{ 'selected' if chart.color_type in [2, '2'] }}{% endif %}>{{ _('Sequential') }}</option>
            </select>  
          </div>


          <div class="seq-colors-{{ n }} {% if chart %}{{ 'hidden' if chart.color_type in [1, '1'] }}{% endif %}">
            {% if chart and chart.seq_color %}
              {% set starting_color = chart.seq_color.split(',')[0] %}
              {% set ending_color = chart.seq_color.split(',')[1] %}
            {% else %}
              {% set starting_color = "#feedde" %}
              {% set ending_color = "#fdbe85" %}
            {% endif %}
            <input type="hidden" value="{% if chart and chart.seq_color %}{{ chart.seq_color }}{% else %}#feedde,#fdbe85{% endif %}" name="seq_colors_hidden_input_{{ n }}" id="seq_colors_hidden_input_{{ n }}" />
            
            <div class="control-group control-select">
              <label class="control-label" for="seq_colors_starting_{{ n }}">{{ _('Starting color') }}</label>
              <input type="color" id="seq_colors_starting_{{ n }}" name="seq_colors_starting_{{ n }}" class="colorpicker" value="{{ starting_color }}" />
            </div>

            <div class="control-group control-select">
              <label class="control-label" for="seq_colors_ending_{{ n }}">{{ _('Ending color') }}</label>
              <input type="color" id="seq_colors_ending_{{ n }}" name="seq_colors_ending_{{ n }}" class="colorpicker" value="{{ ending_color }}" />
            </div>

            <div class="seq-color-preview" id="seq_color_preview_{{ n }}" style="background-image: linear-gradient(to right, {{ starting_color }}, {{ ending_color }});"></div>
          </div>
          
          <div class="control-group control-select diver-colors-{{ n }} {% if chart %}{{ 'hidden' if chart.color_type in [2, '2'] }}{% endif %}">
            {% if plotly %}
              <input type="hidden" id="chart_field_plotly_{{ n }}" name="chart_field_plotly_{{ n }}" {% if chart %} value="{{ chart.plotly }}" {% endif %} />

              {% set counter = {'color_count': 1} %}
              {% if selected_chart_type in ['pie', 'donut'] %}
                {% for i in range(plotly[0].labels | length) %}
                  {% set color = h.color_to_hex(plotly[0].marker.colors[i]) if "colors" in plotly[0].marker else "#8FBC8F" %}
                  {% set name = plotly[0].labels[i] %}
                  <div class="control-group control-select grid grid-cols-2">
                    <label class="control-label" for="chart_field_color_{{ n }}_{{ counter.color_count }}">{{ name }}</label>
                    <input type="color" id="chart_field_color_{{ n }}_{{ counter.color_count }}" name="chart_field_color_{{ n }}_{{ counter.color_count }}" class="colorpicker" value="{% if chart %}{{ color }}{% else %}#8FBC8F{% endif %}" />
                  </div>
                  {% set counter = counter.update({'color_count': counter.color_count + 1}) or counter %}
                {% endfor %}
              {% else %}
                {% for a in plotly %}
                  {% set color = h.color_to_hex(a.marker.color) %}
                  {% set name = a.name %}
                  <div class="control-group control-select grid grid-cols-2">
                    <label class="control-label" for="chart_field_color_{{ n }}_{{ counter.color_count }}">{{ name }}</label>
                    <input type="color" id="chart_field_color_{{ n }}_{{ counter.color_count }}" name="chart_field_color_{{ n }}_{{ counter.color_count }}" class="colorpicker" value="{% if chart %}{{ color }}{% else %}#8FBC8F{% endif %}" />
                  </div>
                  {% set counter = counter.update({'color_count': counter.color_count + 1}) or counter %}
                {% endfor %}
              {% endif %}

            {% else %}
              {# Color #}
              {% set color_schemes = h.querytool_get_color_scheme() %}
              <input type="hidden" id="chart_field_plotly_{{ n }}" name="chart_field_plotly_{{ n }}" {% if chart %} value="{{ chart.plotly }}" {% endif %} />
              <div class="control-group control-select control-select grid grid-cols-2" id="init_color">
                <label class="control-label" for="chart_field_color_{{ n }}">{{ _('Color') }}</label>
                <input type="color" id="chart_field_color_{{ n }}" name="chart_field_color_{{ n }}" class="colorpicker" value="{% if chart %}{{ color }}{% else %}#8FBC8F{% endif %}" />
              </div>
            {% endif %}
            </div>
          </div>
        </div>

      </div>

      {# X-axis #}
      <div class="accordion-item">
        <div class="accordion-header">
          <button type="button" data-bs-target="#accordion_{{ chart_id }}_x_axis" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('X-axis') }}
          </button>
        </div>
        <div id="accordion_{{ chart_id }}_x_axis" class="accordion-collapse collapse">
          <div class="accordion-body">

            {# X-axis title #}
            {% if chart %}
              {% set x_label = chart.x_label %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set x_label_option = false %}
            {% else %}
              {% set x_label_option = true %}
            {% endif %}
            <div class="control-group x-title">
               <label class="control-label" for="chart_field_x_label_{{ n }}">{{ _('X axis title') }}</label>
               <div class="controls ">
                  <textarea id="chart_field_x_label_{{ n }}" name="chart_field_x_label_{{ n }}" placeholder="{{ _('Dimension by default') }}" rows="3">{{ x_label }}</textarea>
               </div>
            </div>

            <div class="control-group x-title-vars">
              <div class="controls ">
                {% set filters = h.querytool_parse_json(info_query_filters or '[]') %}
                {% set filters = filters|sort(attribute='order') %}
                <select>
                  <option value="" disabled selected>{{_('Add variable to title')}}</option>
                  <optgroup label="{{_('Capitalized')}}">
                    <option value="{measure|capitalize}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|capitalize}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|capitalize}">{{_('Optional Filter')}}</option>
                  </optgroup>
                  <optgroup label="{{_('lowercase')}}" class='text-lowercase'>
                    <option value="{measure|lower}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|lower}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|lower}">{{_('Optional Filter')}}</option>
                  </optgroup>
                </select>

              </div>
            </div>
            <div class="control-group x-title-help">
              <div class="controls ">
                {% set template_tooltip = "<pre><p>" + _('Variables') + "<br>---<br>{measure}<br>{optional_filter}<br>*" + _('use drop-down list to select variables based on application filters') + "</p><p>" + _('Processed variables') + "<br>---<br>{measure|capitalize}<br>{measure|lower}<br>{measure|upper}<br>" + _('etc') + "</p></pre><p><b><a href='https://mozilla.github.io/nunjucks/templating.html#variables' target='_blank'>" + _('Full templates syntax') + "</a></b></p><p class='muted'><b>" + _('Please note:') + " " + "</b>" + _('Single braces \'{}\' are used for variables') + "</p>" %}
                <span class="editor-info-block">{{_('You can use')}} <a href="#templates" title="" data-trigger="focus" data-target="popover" data-content="{{ template_tooltip }}" data-html="true" data-original-title="{{_('Templates quick reference')}}" data-container="body">{{_('Templates')}}</a> {{_('here')}}</span>
              </div>
            </div>

            {# X-axis title hide #}
            {% if chart %}
              {% set x_label_hide = chart.x_label_hide %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set x_label_hide_option = false %}
            {% else %}
              {% set x_label_hide_option = true %}
            {% endif %}
            <div class="control-group flex items-center gap-x-4">
               <label class="control-label" for="chart_field_x_label_hide_{{ n }}">{{ _('Hide title') }}</label>
               <div class="controls ">
                  <input id="chart_field_x_label_hide_{{ n }}" class="chart-checkbox" type="checkbox" name="chart_field_x_label_hide_{{ n }}" value="{{ x_label_hide }}" {% if x_label_hide=='true' %}checked{% endif %} >
               </div>
            </div>

            {# X-axis from zero #}
            {% if chart %}
              {% set x_from_zero = chart.x_from_zero %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set x_from_zero_option = false %}
            {% else %}
              {% set x_from_zero_option = true %}
            {% endif %}
            <div class="control-group flex items-center gap-x-4">
               <label class="control-label" for="chart_field_x_from_zero_{{ n }}">{{ _('Start from zero') }}</label>
               <div class="controls ">
                  <input id="chart_field_x_from_zero_{{ n }}"  class="chart-checkbox" type="checkbox" name="chart_field_x_from_zero_{{ n }}" value="{{ x_from_zero }}" {% if x_from_zero=='true' %}checked{% endif %} {{''if x_from_zero_option else 'disabled'}}>
               </div> 
            </div>

            {# X-axis label orientation #}
            {% set text_rotation = h.querytool_get_tick_text_rotation() %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set text_rotation_option = false %}
            {% else %}
              {% set text_rotation_option = true %}
            {% endif %}
            <div class="control-group control-select">
              <label class="control-label" for="chart_field_x_text_rotate_{{ n }}">{{ _('Label orientation') }}</label>
              <div class="controls ">
                <select id="chart_field_x_text_rotate_{{ n }}" name="chart_field_x_text_rotate_{{ n }}" {{'' if text_rotation_option else 'disabled'}}>
                  {% for rotate in text_rotation %}
                  <option value="{{ rotate.value }}" {% if chart %}{{ 'selected' if rotate.value == chart.x_text_rotate }}{% endif %}>{{ rotate.text }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            

            {# X-axis label multiline #}
            {% if chart %}
              {% set x_text_multiline = chart.x_text_multiline %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set x_text_multiline_option = false %}
            {% else %}
              {% set x_text_multiline_option = true %}
            {% endif %}
            

            {# X-axis ticks #}
            {% if chart %}
              {% set x_tick_culling_max = chart.x_tick_culling_max %}
            {% endif %}
            {% if selected_chart_type in ['bar', 'hbar', 'sbar', 'shbar', 'pie', 'donut'] %}
              {% set x_tick_culling_max_option = true %}
            {% else %}
              {% set x_tick_culling_max_option = false %}
            {% endif %}

            {% if selected_chart_type in ['line', 'spline', 'area', 'scatter'] %}
              {% set x_tick_culling_max_option_hide = '' %}
            {% else %}
              {% set x_tick_culling_max_option_hide = 'hidden' %}
            {% endif %}
            <div class="control-group {{x_tick_culling_max_option_hide}}" id="max_labels__{{ n }}">
              <label class="control-label" for="chart_field_x_tick_culling_max_{{ n }}">{{ _('Max number of text labels') }}</label>
              <div class="controls ">
                <input id="chart_field_x_tick_culling_max_{{ n }}" type="number" min="0" step="1" name="chart_field_x_tick_culling_max_{{ n }}" placeholder="10" value="{{ x_tick_culling_max }}" {{'disabled' if x_tick_culling_max_option else ''}}>
              </div>
            </div>

            {# X-axis label format #}
            {% if chart and chart.tick_count%}
              {% set ticks_formats = h.queytool_get_charts_data_formats(5) %}
            {% else %}
              {% set ticks_formats = h.queytool_get_charts_data_formats() %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set ticks_formats_option = false %}
            {% else %}
              {% set ticks_formats_option = true %}
            {% endif %}
            <div class="control-group control-select">
               <label class="control-label" for="chart_field_x_ticks_format_{{ n }}">{{ _('X axis label format') }}</label>
               <div class="controls ">
                  <select id="chart_field_x_ticks_format_{{ n }}" name="chart_field_x_ticks_format_{{ n }}" >
                  {% for tick in ticks_formats %}
                  <option value="{{ tick.value }}" {% if chart %}{{ 'selected' if tick.value == chart.x_tick_format }}{% endif %} >{{ tick.text }}</option>
                  {% endfor %}
                  </select>
               </div>
            </div>

            {# X-axis sort labels #}
            {% if chart %}
              {% set x_sort_labels = chart.x_sort_labels %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set x_sort_labels_disable = 'disabled' %}
            {% else %}
              {% set x_sort_labels_disable = '' %}
            {% endif %}

            <div class="control-group disabled {{x_sort_labels_disable}} flex items-center gap-x-4">
              <label class="control-label" for="chart_field_x_sort_labels_{{ n }}">{{ _('Sort x axis labels') }}</label>
              <div class="controls ">
                 <input id="chart_field_x_sort_labels_{{ n }}" type="checkbox" name="chart_field_x_sort_labels_{{ n }}" value="{{ x_sort_labels }}" {% if x_sort_labels=='true' %}checked{% endif %}>
              </div>
            </div>

          </div>
        </div>
      </div>

      {# Y-axis #}
      <div class="accordion-item">
        <div class="accordion-header">
          <button data-bs-target="#accordion_{{ chart_id }}_y_axis" type="button" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('Y-axis') }}
          </a>
        </div>
        <div id="accordion_{{ chart_id }}_y_axis" class="accordion-collapse collapse">
          <div class="accordion-body ">
            {# Y-axis title #}
            {% if chart %}
              {% set y_label = chart.y_label %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set y_label_option = false %}
            {% else %}
              {% set y_label_option = true %}
            {% endif %}
            <div class="control-group y-title mb-0">
               <label class="control-label" for="chart_field_y_label_{{ n }}">{{ _('Y axis title') }}</label>
               <div class="controls ">
                  <textarea id="chart_field_y_label_{{ n }}" name="chart_field_y_label_{{ n }}" placeholder="{{ _('Measure by default') }}" {{'' if y_label_option else 'disabled'}} rows="3">{{ y_label }}</textarea>
               </div>
            </div>

            <div class="control-group y-title-vars mb-0">
              <div class="controls ">
                {% set filters = h.querytool_parse_json(info_query_filters or '[]') %}
                {% set filters = filters|sort(attribute='order') %}
                <select>
                  <option value="" disabled selected>{{_('Add variable to title')}}</option>
                  <optgroup label="{{_('Capitalized')}}">
                    <option value="{measure|capitalize}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|capitalize}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|capitalize}">{{_('Optional Filter')}}</option>
                  </optgroup>
                  <optgroup label="{{_('lowercase')}}" class='text-lowercase'>
                    <option value="{measure|lower}">{{_('Measure')}}</option>
                    {% for filter in filters %}
                      <option value="{{'{%s|lower}' % filter.slug}}">{{ filter.alias }}</option>
                    {% endfor %}
                    <option value="{optional_filter|lower}">{{_('Optional Filter')}}</option>
                  </optgroup>
                </select>

              </div>
            </div>
            <div class="control-group y-title-help">
              <div class="controls ">
                {% set template_tooltip = "<pre><p>" + _('Variables') + "<br>---<br>{measure}<br>{optional_filter}<br>*" + _('use drop-down list to select variables based on application filters') + "</p><p>" + _('Processed variables') + "<br>---<br>{measure|capitalize}<br>{measure|lower}<br>{measure|upper}<br>" + _('etc') + "</p></pre><p><b><a href='https://mozilla.github.io/nunjucks/templating.html#variables' target='_blank'>" + _('Full templates syntax') + "</a></b></p><p class='muted'><b>" + _('Please note:') + " " + "</b>" + _('Single braces \'{}\' are used for variables') + "</p>" %}
                <span class="editor-info-block">{{_('You can use')}} <a href="#templates" title="" data-trigger="focus" data-target="popover" data-content="{{ template_tooltip }}" data-html="true" data-original-title="{{_('Templates quick reference')}}" data-container="body">{{_('Templates')}}</a> {{_('here')}}</span>
              </div>
            </div>

            {# Y-axis title hide #}
            {% if chart %}
              {% set y_label_hide = chart.y_label_hide %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set y_label_hide_option = false %}
            {% else %}
              {% set y_label_hide_option = true %}
            {% endif %}
            <div class="control-group flex items-center gap-x-4">
               <label class="control-label" for="chart_field_y_label_hide_{{ n }}">{{ _('Hide title') }}</label>
               <div class="controls ">
                  <input id="chart_field_y_label_hide_{{ n }}" type="checkbox" name="chart_field_y_label_hide_{{ n }}" value="{{ y_label_hide }}" {% if y_label_hide=='true' %}checked{% endif %} {{'' if y_label_hide_option else 'disabled'}}>
               </div>
            </div>

            {# Y-axis from zero #}
            {% if chart %}
              {% set y_from_zero = chart.y_from_zero %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set y_from_zero_option = false %}
            {% else %}
              {% set y_from_zero_option = true %}
            {% endif %}
            <div class="control-group flex items-center gap-x-4">
               <label class="control-label" for="chart_field_y_from_zero_{{ n }}">{{ _('Start from zero') }}</label>
               <div class="controls ">
                  <input id="chart_field_y_from_zero_{{ n }}" type="checkbox" name="chart_field_y_from_zero_{{ n }}" value="{{ y_from_zero }}" {% if y_from_zero=='true' %}checked{% endif %} {{'' if y_from_zero_option else 'disabled'}}>
               </div>
            </div>

            {# Y-axis label format #}
            {% if chart and chart.tick_count%}
              {% set ticks_formats = h.queytool_get_charts_data_formats(5) %}
            {% else %}
              {% set ticks_formats = h.queytool_get_charts_data_formats() %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set ticks_formats_option = false %}
            {% else %}
              {% set ticks_formats_option = true %}
            {% endif %}
            <div class="control-group control-select">
               <label class="control-label" for="chart_field_y_ticks_format_{{ n }}">{{ _('Y axis label format') }}</label>
               <div class="controls ">
                  <select id="chart_field_y_ticks_format_{{ n }}" name="chart_field_y_ticks_format_{{ n }}" {{'' if ticks_formats_option else 'disabled'}}>
                  {% for tick in ticks_formats %}
                  <option value="{{ tick.value }}" {% if chart %}{{ 'selected' if tick.value == chart.y_tick_format }}{% endif %} >{{ tick.text }}</option>
                  {% endfor %}
                  </select>
               </div>
            </div>

          </div>
        </div>
      </div>

      {# Additional Options #}
      <div class="accordion-item">
        <div class="accordion-header">
          <button type="button" data-bs-target="#accordion_{{ chart_id }}_graph" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('Additional Options') }}
          </button>
        </div>
        <div id="accordion_{{ chart_id }}_graph" class="accordion-collapse collapse">
          <div class="accordion-body">
            
            {# X sorting #}
            {% set sort_options = h.querytool_get_chart_sort() %}
            <div id="chart_field_sort_div_{{ n }}" class="control-group control-select {% if chart and chart.category_name %}hidden{% endif %}">
              <label class="control-label" for="chart_field_sort_{{ n }}">{{ _('Data sorting') }}</label>
              <div class="controls ">
                <select id="chart_field_sort_{{ n }}" name="chart_field_sort_{{ n }}" >
                  {% for sort in sort_options %}
                  <option value="{{ sort.value }}" {% if chart %}{{ 'selected' if sort.value == chart.sort }}{% endif %} >{{ sort.text }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            {# Data format #}
            {% set data_formats = h.queytool_get_charts_data_formats() %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set data_formats_option = false %}
              {% set hide_data_format = 'hidden' %}
            {% else %}
              {% set data_formats_option = true %}
              {% set hide_data_format = '' %}
            {% endif %}
            <div class="control-group control-select {{hide_data_format}}" id="chart_field_data_format_control_{{ n }}">
              <label class="control-label" for="chart_field_data_format_{{ n }}">{{ _('Data format') }}</label>
              <div class="controls ">
                <select id="chart_field_data_format_{{ n }}" name="chart_field_data_format_{{ n }}" {{'' if data_formats_option else 'disabled'}}>
                  {% for format in data_formats %}
                  <option value="{{ format.value }}" {% if chart %}{{ 'selected' if format.value == chart.data_format }}{% endif %} >{{ format.text }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            {# Donut chart hole #}
            {% if chart %}
              {% set donut_hole = chart.donut_hole or 0.4 %}

              {% if donut_hole == 'None' %}
                {% set donut_hole = 0.4 %}
              {% endif %}

            {% endif %}
            {% if selected_chart_type in ['line', 'bar', 'hbar', 'sbar', 'shbar'] %}
              {% set donut_option = false %}
              {% set hide_donut = 'hidden' %}
            {% else %}
              {% set donut_option = true %}
              {% set hide_donut = '' %}
            {% endif %}

            <div class="control-group {{hide_donut}}" id="chart_donut_hole_{{n}}">
               <label class="control-label" for="chart_field_donut_hole_{{ n }}">{{ _('Donut hole') }}</label>
               <div class="controls ">
                  <input id="chart_field_donut_hole_{{ n }}"  type="text" name="chart_field_donut_hole_{{ n }}" value="{{ h.convert_bar_width(donut_hole, True, 'donut')|default (4.0) }}" placeholder="{{ _('Donut hole, default 4.0') }}">
                  {{ form.info(_('An integer or decimal between 0.1-10.')) }}
               </div>
            </div>

            {# Bar chart width #}
            {% if chart %}
              {% set bar_width = chart.bar_width or 0.5 %}

              {% if bar_width == 'None' %}
                {% set bar_width = 0.5 %}
              {% endif %}

            {% endif %}

            {% if selected_chart_type in ['line', 'donut', 'pie'] %}
              {% set bar_width_option = false %}
              {% set hide_bar_width = 'hidden' %}
            {% else %}
              {% set bar_width_option = true %}
              {% set hide_bar_width = ''  %}
            {% endif %}

            <div class="control-group {{ hide_bar_width }}" id="chart_bar_width_{{n}}">
               <label class="control-label" for="chart_field_bar_width_{{ n }}">{{ _('Bar width') }}</label>
               <div class="controls ">
                  <input id="chart_field_bar_width_{{ n }}" type="text" name="chart_field_bar_width_{{ n }}" value="{{ h.convert_bar_width(bar_width, True)|default (5.0)}}" placeholder="{{ _('Width of bar, default 5.0') }}">
                  {{ form.info(_('An integer or decimal between 0.1-10.')) }}
               </div>
            </div>

            {# Show labels #}
            {% if chart %}
              {% set show_labels = chart.show_labels %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set show_labels_option = false %}
            {% else %}
              {% set show_labels_option = true %}
            {% endif %}

            {# Show legend #}
            {% if chart %}
              {% set show_legend = chart.show_legend %}
            {% endif %}
            <div class="control-group flex items-center gap-x-4">
               <label class="control-label" for="chart_field_legend_{{ n }}">{{ _('Show legend') }}</label>
               <div class="controls ">
                  <input id="chart_field_legend_{{ n }}" type="checkbox" name="chart_field_legend_{{ n }}" value="{{ show_legend }}"{% if show_legend=='false' %}{% else %}checked{% endif %}>
               </div>
            </div>

            {# Show legend title #}
            {% if chart %}
              {% set show_legend_title = chart.show_legend_title %}
            {% endif %}
            {% if show_legend == 'false' %}
              {% set show_legend_title_disable = 'disabled' %}
            {% else %}
              {% set show_legend_title_disable = '' %}
            {% endif %}

            <div class="control-group flex items-center gap-x-4">
               <label class="control-label" for="chart_field_leg_title_{{ n }}">{{ _('Show legend title') }}</label>
               <div class="controls ">
                  <input id="chart_field_leg_title_{{ n }}" type="checkbox" name="chart_field_leg_title_{{ n }}" value="{{ show_legend_title }}"{% if show_legend_title=='false' %}{% else %}checked{% endif %} {{show_legend_title_disable}}>
               </div>
            </div>

            {# Custom legend title #}
            {% if chart %}
              {% set custom_legend_title = chart.custom_legend_title %}
            {% endif %}
            {% if show_legend_title == 'false' %}
              {% set custom_legend_title_disable = 'disabled' %}
            {% else %}
              {% set custom_legend_title_disable = '' %}
            {% endif %}

            <div class="control-group">
              <label class="control-label" for="custom_legend_title_{{ n }}">{{ _('Custom legend title') }}</label>
              <div class="controls "> 
                 <input id="custom_legend_title_{{ n }}" type="text" name="custom_legend_title_{{ n }}" value="{{ custom_legend_title }}" placeholder="{{ _('Dimension by default') }}" {{custom_legend_title_disable}}>
              </div>
           </div>

            {# Show annotations #}
            {% if chart %}
              {% set show_annotations = chart.show_annotations %}
            {% endif %}
            <div class="control-group items-center gap-x-4 flex">
               <label class="control-label" for="chart_field_show_annotations_{{ n }}">{{ _('Show annotations') }}</label>
               <div class="controls ">
                  <input id="chart_field_show_annotations_{{ n }}" type="checkbox" name="chart_field_show_annotations_{{ n }}" value="{{ show_annotations }}" {% if show_annotations=='true' %}checked{% endif %}>
               </div>
            </div>


            {# Show values as percentages (pie and donut charts only) #}
            {% if chart %}
              {% set show_labels_as_percentages = chart.show_labels_as_percentages %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set show_labels_as_percentages_option = true %}
            {% else %}
              {% set show_labels_as_percentages_option = false %}
            {% endif %}

            {# Show bounds #}
            {% if chart %}
              {% set show_bounds = chart.show_bounds %}
            {% endif %}


            {% if selected_chart_type in ['bar', 'hbar', 'sbar', 'shbar', 'line', 'spline', 'area', 'scatter'] %} 
              {% set hide_bounds = '' %}
            {% else %}
              {% set hide_bounds = 'hidden' %}
            {% endif %}
            {# Upper bounds #}

            <div class="control-group {{hide_bounds}} flex items-center gap-x-4" id="show_bounds_checkbox_{{n}}">
               <label class="control-label" for="chart_field_show_bounds_{{ n }}">{{ _('Show bounds') }}</label>
               <div class="controls ">
                  <input id="chart_field_show_bounds_{{ n }}" type="checkbox" name="chart_field_show_bounds_{{ n }}" value="{{ show_bounds }}" {% if show_bounds=='true' %}checked{% endif %}>
               </div>
            </div>

            {% if selected_chart_type in ['bar', 'hbar', 'sbar', 'shbar', 'line', 'spline', 'area', 'scatter'] and show_bounds=='false' %}
              {% set hide_bounds = 'hidden' %}
            {% endif %}

            <div class="control-group control-select {{hide_bounds}}" id="lower_bounds_{{n}}">
              <label class="control-label" for="chart_field_lower_bounds_{{ n }}">{{ _('Lower bounds') }}</label>
              <div class="controls ">
                <select id="chart_field_lower_bounds_{{ n }}" name="chart_field_lower_bounds_{{ n }}">
                <option value="">&mdash; {{ _('Select column') }} &mdash;</option>
                  {% for column in numeric_columns %}
                  <option value="{{column}}"{% if chart %}{{ 'selected' if column == chart.lower_bounds }}{% endif %}>{{column}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            {# Lower bounds #}
            <div class="control-group control-select {{hide_bounds}}" id="upper_bounds_{{n}}">
              <label class="control-label" for="chart_field_upper_bounds_{{ n }}">{{ _('Upper bounds') }}</label>
              <div class="controls ">
                <select id="chart_field_upper_bounds_{{ n }}" name="chart_field_upper_bounds_{{ n }}">
                <option value="">&mdash; {{ _('Select column') }} &mdash;</option>
                  {% for column in numeric_columns %}
                  <option value="{{column}}"{% if chart %}{{ 'selected' if column == chart.upper_bounds }}{% endif %}>{{column}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            {# {% endif %} #}

            {# Axis percentages #}
            {% if chart %}
              {% set axis_range = chart.axis_range %}
              {% set axis_min = chart.axis_min %}
              {% set axis_max = chart.axis_max %}
            {% endif %}

            {% if selected_chart_type not in ['pie', 'donut', 'sbar', 'shbar'] %}
              {% set show_range = '' %}
            {% else %}
              {% set show_range = 'hidden' %}
            {% endif %}

            {% if axis_range=='true' and selected_chart_type not in ['pie', 'donut', 'sbar', 'shbar'] %}
              {% set show_range_options = '' %}
            {% else %}
              {% set show_range_options = 'hidden' %}
            {% endif %}

            <div class="control-group {{show_range}} flex items-center gap-x-4" id="show_axis_range_{{ n }}">
               <label class="control-label" for="chart_field_axis_range_{{ n }}">{{ _('Set axis range') }}</label>
               <div class="controls ">
                  <input id="chart_field_axis_range_{{ n }}" type="checkbox" name="chart_field_axis_range_{{ n }}" value="{{ axis_range }}" {% if axis_range=='true' %}checked{% endif %}>
               </div>
            </div>

            {# Axis range min #}
            <div class="control-group {{ show_range_options }}" id="axis_range_min_{{n}}">
               <label class="control-label" for="chart_field_axis_min_{{ n }}">{{ _('Axis range minimum') }}</label>
               <div class="controls ">
                  <input id="chart_field_axis_min_{{ n }}" type="text" name="chart_field_axis_min_{{ n }}" value="{{ axis_min }}" placeholder="{{ _('Axis minimum') }}">
               </div>
            </div>

            {# Axis range max #}
            <div class="control-group {{ show_range_options }}" id="axis_range_max_{{n}}">
               <label class="control-label" for="chart_field_axis_max_{{ n }}">{{ _('Axis range maximum') }}</label>
               <div class="controls ">
                  <input id="chart_field_axis_max_{{ n }}" type="text" name="chart_field_axis_max_{{ n }}" value="{{ axis_max }}" placeholder="{{ _('Axis maximum') }}">
               </div>
            </div>
            {# {% endif %} #}

          </div>
        </div>
      </div>

      {# Optional Filter #}
      <div class="accordion-item">
        <div class="accordion-header">
          <button type="button" data-bs-target="#accordion_{{ chart_id }}_optional_filter" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('Optional Filter') }}
          </button>
        </div>
        <div id="accordion_{{ chart_id }}_optional_filter" class="accordion-collapse collapse">
          <div class="accordion-body">

            {# Optional Filter #}
            <div class="control-group control-select">
              <label class="control-label" for="chart_field_filter_name_{{ n }}">{{ _('Dimension') }}</label>
              <div class="controls ">
                <select id="chart_field_filter_name_{{ n }}" name="chart_field_filter_name_{{ n }}">
                  <option value="">&mdash; {{ _('Select column') }} &mdash;</option>
                  {% for filter in chart_filters %}
                  <option value="{{filter}}"{% if chart %}{{ 'selected' if filter == chart.filter_name }}{% endif %}>{{filter}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            {# Optional Filter Default Value #}
            <div id="chart_div_filter_value_{{ n }}" class="control-group control-select {{ class }}">
              <label class="control-label" for="chart_field_filter_value_{{ n }}">{{ _('Default value') }}</label>
              <div class="controls ">
                <select id="chart_field_filter_value_{{ n }}" name="chart_field_filter_value_{{ n }}" >
                  <option value="">&mdash; {{ _('Select value') }} &mdash;</option>
                  {% if chart and chart.filter_value %}
                  <option value="{{ chart.filter_value }}" selected>{{ chart.filter_value }}</option>
                  {% endif %}
                </select>
              </div>
            </div>

            {# Optional Filter Alias #}
            <div id="chart_div_filter_alias_{{ n }}" class="control-group {{ class }}">
              <label class="control-label" for="chart_field_filter_alias_{{ n }}">{{ _('Filter Label') }}</label>
              <div class="controls ">
                <input id="chart_field_filter_alias_{{ n }}" name="chart_field_filter_alias_{{ n }}" {% if chart and chart.filter_alias %}value="{{chart.filter_alias}}"{% else %}value=""{% endif %} placeholder="{{ _('Enter filter Label') }}" type="text">
              </div>
            </div>

            {# Optional Filter Visability #}
            <div id="chart_div_filter_visibility_{{ n }}" class="control-group control-select {{ class }}">
              <label class="control-label" for="chart_field_filter_visibility_{{ n }}">{{ _('Filter visibility') }}</label>
              <div class="controls ">
                <select id="chart_field_filter_visibility_{{ n }}" name="chart_field_filter_visibility_{{ n }}" >
                  <option value="public" {{ 'selected' if chart and chart.filter_visibility == 'public' }}>{{ _('Public') }}</option>
                  <option value="private" {{ 'selected' if chart and chart.filter_visibility == 'private' }}>{{ _('Private') }}</option>
                </select>
              </div>
            </div>

          </div>
        </div>
      </div>

      {# Static Reference #}
      <div class="accordion-item">
        <div class="accordion-header">
          <button type="button" data-bs-target="#accordion_{{ chart_id }}_static_reference" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('Static Reference') }}
          </button>
        </div>
        <div id="accordion_{{ chart_id }}_static_reference" class="accordion-collapse collapse">
          <div class="accordion-body">

            {# Static Reference Columns #}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set static_reference_columns_option = false %}
            {% else %}
              {% set static_reference_columns_option = true %}
            {% endif %}
            <div class="control-group ">
               <label class="control-label" for="chart_field_static_reference_columns_{{ n }}">{{ _('Static Reference Columns') }}</label>
               <div class="controls ">
                 <select id="chart_field_static_reference_columns_{{ n }}" name="chart_field_static_reference_columns_{{ n }}" multiple style="width:100%" {{'' if static_reference_columns_option else 'disabled'}}>
                   {% for measure in y_axis_values %}
                     <optgroup label="{{ measure }}">
                       {% for column in numeric_columns %}
                         {% set value = [measure, column]|join('|') %}
                         <option value="{{ value }}" {% if chart %}{{ 'selected' if value in chart.static_reference_columns }}{% endif %}>
                          {{column}} ({{measure}})
                         </option>
                       {% endfor %}
                     </optgroup>
                   {% endfor %}
                 </select>
               </div>
            </div>

            {# Static Reference Label #}
            {% if chart %}
              {% set static_reference_label = chart.static_reference_label %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set static_reference_label_option = false %}
            {% else %}
              {% set static_reference_label_option = true %}
            {% endif %}
            <div class="control-group ">
               <label class="control-label" for="chart_field_static_reference_label_{{ n }}">{{ _('Static Reference Label') }}</label>
               <div class="controls ">
                  <input id="chart_field_static_reference_label_{{ n }}" type="text" name="chart_field_static_reference_label_{{ n }}" value="{{ static_reference_label }}" placeholder="{{ _('Static Reference') }}" {{'' if static_reference_label_option else 'disabled'}}>
               </div>
            </div>

          </div>
        </div>
      </div>

      {# Dynamic Reference #}
      <div class="accordion-item">
        <div class="accordion-header">
          <button type="button" data-bs-target="#accordion_{{ chart_id }}_dynamic_reference" class="accordion-button collapsed" data-bs-toggle="collapse" data-parent="#accordion_{{ chart_id }}">
            {{ _('Dynamic Reference') }}
          </button>
        </div>
        <div id="accordion_{{ chart_id }}_dynamic_reference" class="accordion-collapse collapse">
          <div class="accordion-body">

            {# Dynamic Reference Type #}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set dynamic_reference_type_option = false %}
            {% else %}
              {% set dynamic_reference_type_option = true %}
            {% endif %}
            <div class="control-group ">
               <label class="control-label" for="chart_field_dynamic_reference_type_{{ n }}">{{ _('Dynamic Reference Type') }}</label>
               <div class="controls ">
                 <select id="chart_field_dynamic_reference_type_{{ n }}" name="chart_field_dynamic_reference_type_{{ n }}" {{'' if dynamic_reference_type_option else 'disabled'}}>
                   <option value="">&mdash; {{ _('Select type') }} &mdash;</option>
                   {% for type in ['Maximum', 'Average', 'Minimum'] %}
                     <option value="{{type}}"
                        {% if chart %}
                          {{ 'selected' 
                              if type == chart.dynamic_reference_type 
                          }}
                        {% endif %}>
                      {{ _(type) }}</option>
                   {% endfor %}
                 </select>
               </div>
            </div>

            {# Dynamic Reference Factor #}
            {% if chart %}
              {% set dynamic_reference_factor = chart.dynamic_reference_factor %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set dynamic_reference_factor_option = false %}
            {% else %}
              {% set dynamic_reference_factor_option = true %}
            {% endif %}
            <div class="control-group ">
               <label class="control-label" for="chart_field_dynamic_reference_factor_{{ n }}">{{ _('Dynamic Reference Factor') }}</label>
               <div class="controls ">
                  <input id="chart_field_dynamic_reference_factor_{{ n }}" type="number" min="0" step="0.1" name="chart_field_dynamic_reference_factor_{{ n }}" value="{{ dynamic_reference_factor }}" default="1" placeholder="1" {{'' if dynamic_reference_factor_option else 'disabled'}}>
               </div>
            </div>

            {# Dynamic Reference Label #}
            {% if chart %}
              {% set dynamic_reference_label = chart.dynamic_reference_label %}
            {% endif %}
            {% if selected_chart_type in ['pie', 'donut'] %}
              {% set dynamic_reference_label_option = false %}
            {% else %}
              {% set dynamic_reference_label_option = true %}
            {% endif %}
            <div class="control-group ">
               <label class="control-label" for="chart_field_dynamic_reference_label_{{ n }}">{{ _('Dynamic Reference Label') }}</label>
               <div class="controls ">
                  <input id="chart_field_dynamic_reference_label_{{ n }}" type="text" name="chart_field_dynamic_reference_label_{{ n }}" value="{{ dynamic_reference_label }}" placeholder="{{ _('Dynamic Reference') }}" {{'' if dynamic_reference_label_option else 'disabled'}}>
               </div>
            </div>

          </div>
        </div>
      </div>

    </div>


    {# Controls #}
    <input type="hidden" id="chart_field_axis_y_{{ n }}" name="chart_field_axis_y_{{ n }}" {% if chart %} value="{{ chart.y_axis }}" {% endif %} />
    <ul class="inline text-right chart-actions flex items-center gap-x-4 p-0 mt-4">
       <li class="remove"><a class="btn delete-item-btn">{% block delete_button_text %}<span class="fa fa-trash-o" aria-hidden="true"></span> {{ _('Delete') }}{% endblock %}</a></li>
       <li><button class="btn copy-chart-btn" type="submit" id="copy-viz-btn_{{ n }}" name="copy-viz-btn_{{ n }}"><span class="fa fa-copy" aria-hidden="true"></span> {{ _('Copy') }}</button></li>
       <li><a class="btn update-chart-btn"><span class="fa fa-refresh" aria-hidden="true"></span> {{ _('Update') }}</a></li>
    </ul>
    <span class="grippy"></span>

    {# Legacy #}
    {#{% if chart %}
      {% set tooltip_name = chart.tooltip_name %}
    {% endif %}
    <div class="control-group hidden">
       <label class="control-label" for="chart_field_tooltip_name_{{ n }}">{{ _('Tooltip name') }}</label>
       <div class="controls ">
          <input id="chart_field_tooltip_name_{{ n }}" type="text" name="chart_field_tooltip_name_{{ n }}" value="{{ tooltip_name }}" placeholder="{{ _('Tooltip name') }}">
       </div>
    </div>
    {% if chart %}
      {% set ptop = chart.padding_top %}
    {% endif %}
    <div class="control-group hidden">
       <label class="control-label" for="chart_field_padding_top_{{ n }}">{{ _('Padding top') }}</label>
       <div class="controls ">
          <input id="chart_field_padding_top_{{ n }}" type="number" min="0" name="chart_field_padding_top_{{ n }}" value="{{ ptop }}" placeholder="{{ _('Default') }}">
       </div>
    </div>
    {% if chart %}
      {% set pbtm = chart.padding_bottom %}
    {% endif %}
    <div class="control-group hidden">
       <label class="control-label" for="chart_field_padding_bottom_{{ n }}">{{ _('Padding bottom') }}</label>
       <div class="controls ">
          <input id="chart_field_padding_bottom_{{ n }}" type="number" min="0" name="chart_field_padding_bottom_{{ n }}" value="{{ pbtm }}" placeholder="{{ _('Default') }}">
       </div>
    </div>
    {% if chart %}
      {% set tick_count = chart.tick_count %}
    {% endif %}
    <div class="control-group hidden">
       <label class="control-label" for="chart_field_tick_count_{{ n }}">{{ _('Y axis tick count') }}</label>
       <div class="controls ">
          <input id="chart_field_tick_count_{{ n }}" type="number" min="0" name="chart_field_tick_count_{{ n }}" value="{{ tick_count }}" placeholder="{{ _('Default') }}">
       </div>
    </div>#}

  </div>
<!--  <div style="width:65%;">-->

  <div style="height:500px;" class="ch-width">
      {% if chart %}
          {% set colors = chart.color %}
          {% set seq_color = chart.seq_color %}
          {% set color_type = chart.color_type %}
          {% set x_axis = chart.x_axis %}
          {% set y_axis = chart.y_axis %}
          {% set chart_type = chart.graph %}
          {% set title = chart.title %}
          {% set show_legend = chart.show_legend %}
          {% set show_legend_title = chart.show_legend_title %}
          {% set custom_legend_title = chart.custom_legend_title %}
          {% set show_annotations = chart.show_annotations %}
          {% set x_text_rotate = chart.x_text_rotate %}
          {% set x_text_multiline = chart.x_text_multiline %}
          {% set x_tick_culling_max = chart.x_tick_culling_max %}
          {% set tooltip_name = chart.tooltip_name %}
          {% set data_format = chart.data_format %}
          {% set y_tick_format = chart.y_tick_format %}
          {% set x_tick_format = chart.x_tick_format %}
          {% set chart_padding_left = chart.chart_padding_left %}
          {% set chart_padding_bottom = chart.chart_padding_bottom %}
          {% set padding_bottom = chart.padding_bottom %}
          {% set padding_top = chart.padding_top %}
          {% set tick_count = chart.tick_count %}
          {% set show_labels = chart.show_labels %}
          {% set show_labels_as_percentages = chart.show_labels_as_percentages %}
          {% set y_label = chart.y_label %}
          {% set y_label_hide = chart.y_label_hide %}
          {% set x_label = chart.x_label %}
          {% set x_label_hide = chart.x_label_hide %}
          {% set y_from_zero = chart.y_from_zero %}
          {% set x_from_zero = chart.x_from_zero %}
          {% set filter_name = chart.filter_name %}
          {% set filter_slug = chart.filter_slug %}
          {% set filter_value = chart.filter_value %}
          {% set category_name = chart.category_name %}
          {% set data_sort = chart.sort %}
          {% set static_reference_columns = chart.static_reference_columns %}
          {% set static_reference_label = chart.static_reference_label %}
          {% set dynamic_reference_type = chart.dynamic_reference_type %}
          {% set dynamic_reference_factor = chart.dynamic_reference_factor %}
          {% set dynamic_reference_label = chart.dynamic_reference_label %}
          {% set plotly = chart.plotly %}
          {% set bar_width = chart.bar_width %}
          {% set donut_hole = chart.donut_hole %}
          {% set upper_bounds = chart.upper_bounds %}
          {% set lower_bounds = chart.lower_bounds %}
          {% set show_bounds = chart.show_bounds %}
          {% set axis_min = chart.axis_min %}
          {% set axis_max = chart.axis_max %}
          {% set line_types = chart.line_types %}
          {% set line_widths = chart.line_widths %}
          {% set x_sort_labels = chart.x_sort_labels %}
      {% endif %}
      {% snippet 'ajax_snippets/visualization_item.html',
          type='chart',
          colors=colors,
          seq_color=seq_color,
          color_type=color_type,
          x_axis=x_axis,
          y_axis=y_axis,
          chart_type=chart_type,
          sql_string=sql_string,
          title= title,
          show_legend = show_legend,
          show_legend_title = show_legend_title,
          custom_legend_title = custom_legend_title,
          show_annotations = show_annotations,
          x_text_rotate= x_text_rotate,
          x_text_multiline= x_text_multiline,
          x_tick_culling_max = x_tick_culling_max,
          tooltip_name = tooltip_name,
          data_format = data_format,
          y_tick_format = y_tick_format,
          x_tick_format = x_tick_format,
          chart_padding_left = chart_padding_left,
          chart_padding_bottom = chart_padding_bottom,
          padding_bottom = padding_bottom,
          padding_top = padding_top,
          tick_count = tick_count,
          show_labels = show_labels,
          show_labels_as_percentages = show_labels_as_percentages,
          y_label = y_label,
          y_label_hide = y_label_hide,
          x_label = x_label,
          x_label_hide = x_label_hide,
          y_from_zero = y_from_zero,
          x_from_zero = x_from_zero,
          filter_name=filter_name,
          filter_slug=filter_slug,
          filter_value=filter_value,
          category_name=category_name,
          data_sort = data_sort,
          measure_label=measure_label,
          info_query_filters=info_query_filters,
          static_reference_columns=static_reference_columns,
          static_reference_label=static_reference_label,
          dynamic_reference_type=dynamic_reference_type,
          dynamic_reference_factor=dynamic_reference_factor,
          dynamic_reference_label=dynamic_reference_label,
          plotly = plotly,
          bar_width = bar_width,
          donut_hole = donut_hole,
          upper_bounds = upper_bounds,
          lower_bounds = lower_bounds,
          show_bounds = show_bounds,
          axis_range = axis_range,
          axis_min = axis_min,
          axis_max = axis_max,
          line_types = line_types,
          line_widths = line_widths,
          x_sort_labels = x_sort_labels
      %}
   </div>
</div>
